{% extends "base.html" %}

{% block title %}Profiles - Firefly{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Create New Profile</h5>
            </div>
            <div class="card-body">
                <form id="createProfileForm">
                    <div class="mb-3">
                        <label for="newNodeId" class="form-label">Node ID *</label>
                        <input type="text" class="form-control" id="newNodeId" required maxlength="64" placeholder="e.g. !deadbeef">
                    </div>
                    <div class="mb-3">
                        <label for="newLongName" class="form-label">Long Name *</label>
                        <input type="text" class="form-control" id="newLongName" required maxlength="100" placeholder="e.g. UDP Test">
                    </div>
                    <div class="mb-3">
                        <label for="newShortName" class="form-label">Short Name *</label>
                        <input type="text" class="form-control" id="newShortName" required maxlength="16" placeholder="e.g. UDP">
                    </div>
                    <div class="mb-3">
                        <label for="newChannel" class="form-label">Channel *</label>
                        <input type="text" class="form-control" id="newChannel" required maxlength="64" placeholder="e.g. LongFast">
                    </div>
                    <div class="mb-3">
                        <label for="newKey" class="form-label">Key *</label>
                        <input type="text" class="form-control" id="newKey" required maxlength="256" placeholder="e.g. AQ==">
                    </div>
                    <div class="mb-3">
                        <label for="newHopLimit" class="form-label">Hop Limit</label>
                        <input type="number" class="form-control" id="newHopLimit" min="0" max="7" value="3" placeholder="0-7">
                        <div class="form-text">Number of hops a message can travel (0-7). Default is 3.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Profile</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Existing Profiles</h5>
            </div>
            <div class="card-body">
                {% if profiles %}
                    <div id="profilesList">
                        {% for profile_id, profile in profiles.items() %}
                            <div class="profile-item border rounded p-3 mb-3" data-profile-id="{{ profile_id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ profile.long_name }}</h6>
                                        <small class="text-muted">Short: {{ profile.short_name }} â€¢ Node: {{ profile.node_id }}</small>
                                        <p class="mt-2 mb-1">Channel: {{ profile.channel }} | Key: {{ profile.key }}</p>
                                        <p class="mb-1">Hop Limit: {{ profile.hop_limit if profile.hop_limit is not none else 3 }}</p>
                                        <small class="text-muted">Created: {{ profile.created_at[:10] }}</small>
                                    </div>
                                    <div class="btn-group-vertical" role="group">
                                        <button class="btn btn-outline-primary btn-sm edit-profile-btn" data-profile-id="{{ profile_id }}">
                                            Edit
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm copy-profile-btn" data-profile-id="{{ profile_id }}">
                                            Copy
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm delete-profile-btn" data-profile-id="{{ profile_id }}">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <p>No profiles created yet.</p>
                        <p>Create your first profile to start chatting!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <input type="hidden" id="editProfileId">
                    <div class="mb-3">
                        <label for="editNodeId" class="form-label">Node ID *</label>
                        <input type="text" class="form-control" id="editNodeId" required maxlength="64">
                    </div>
                    <div class="mb-3">
                        <label for="editLongName" class="form-label">Long Name *</label>
                        <input type="text" class="form-control" id="editLongName" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="editShortName" class="form-label">Short Name *</label>
                        <input type="text" class="form-control" id="editShortName" required maxlength="16">
                    </div>
                    <div class="mb-3">
                        <label for="editChannel" class="form-label">Channel *</label>
                        <input type="text" class="form-control" id="editChannel" required maxlength="64">
                    </div>
                    <div class="mb-3">
                        <label for="editKey" class="form-label">Key *</label>
                        <input type="text" class="form-control" id="editKey" required maxlength="256">
                    </div>
                    <div class="mb-3">
                        <label for="editHopLimit" class="form-label">Hop Limit</label>
                        <input type="number" class="form-control" id="editHopLimit" min="0" max="7" value="3" placeholder="0-7">
                        <div class="form-text">Number of hops a message can travel (0-7). Default is 3.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <div class="card">
        <div class="card-header">
            <h6>Profile Management Tips</h6>
        </div>
        <div class="card-body">
            <ul class="mb-0">
                <li><strong>Node ID:</strong> Unique identifier for your device or node</li>
                <li><strong>Long Name:</strong> Descriptive name shown in chat messages</li>
                <li><strong>Short Name:</strong> Short identifier shown in lists and compact views</li>
                <li><strong>Channel:</strong> Communication channel used</li>
                <li><strong>Key:</strong> Encryption or access key</li>
                <li><strong>Hop Limit:</strong> Number of hops (0-7) a message can travel before being dropped. Default is 3.</li>
                <li><strong>Multiple Profiles:</strong> You can create multiple profiles for different purposes</li>
                <li><strong>Profile Selection:</strong> Go back to the chat page to select which profile to use</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('[profiles] script loaded');
let profiles = {};

document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners first so the UI is interactive immediately
    document.getElementById('createProfileForm').addEventListener('submit', createProfile);
    document.getElementById('saveProfileBtn').addEventListener('click', updateProfile);

    // Delegate edit and delete buttons robustly (use closest)
    document.getElementById('profilesList')?.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.edit-profile-btn');
        const copyBtn = e.target.closest('.copy-profile-btn');
        const delBtn = e.target.closest('.delete-profile-btn');
        if (editBtn) {
            openEditModal(editBtn.getAttribute('data-profile-id'));
            return;
        }
        if (delBtn) {
            deleteProfile(delBtn.getAttribute('data-profile-id'));
            return;
        }
        if (copyBtn) {
            const profileId = copyBtn.getAttribute('data-profile-id');
            fetch(`/api/profiles/${profileId}/copy`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Profile copied successfully!');
                    location.reload(); // Reload to show the new copied profile
                }
            })
            .catch(error => {
                console.error('Error copying profile:', error);
                alert('Error copying profile');
            });
            return;
        }
    });

    // Only load profiles, not messages
    loadProfiles();
});

function loadProfiles() {
    fetch('/api/profiles')
        .then(response => response.json())
        .then(data => {
            profiles = data;
        })
        .catch(error => console.error('Error loading profiles:', error));
}

function createProfile(e) {
    e.preventDefault();
    const hopLimitValue = document.getElementById('newHopLimit').value;
    const hopLimit = hopLimitValue === '' ? 3 : parseInt(hopLimitValue);
    
    // Validate hop limit
    if (hopLimit < 0 || hopLimit > 7) {
        alert('Hop limit must be between 0 and 7');
        return;
    }
    
    const payload = {
        node_id: document.getElementById('newNodeId').value.trim(),
        long_name: document.getElementById('newLongName').value.trim(),
        short_name: document.getElementById('newShortName').value.trim(),
        channel: document.getElementById('newChannel').value.trim(),
        key: document.getElementById('newKey').value.trim(),
        hop_limit: hopLimit
    };
    if (Object.values(payload).some(v => !v)) {
        alert('All fields are required');
        return;
    }
    fetch('/api/profiles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) return alert('Error: ' + data.error);
        alert('Profile created successfully!');
        location.reload();
    })
    .catch(err => {
        console.error('Error creating profile:', err);
        alert('Error creating profile');
    });
}

function openEditModal(profileId) {
    const profile = profiles[profileId];
    if (!profile) { alert('Profile not found'); return; }
    document.getElementById('editProfileId').value = profileId;
    document.getElementById('editNodeId').value = profile.node_id || '';
    document.getElementById('editLongName').value = profile.long_name || '';
    document.getElementById('editShortName').value = profile.short_name || '';
    document.getElementById('editChannel').value = profile.channel || '';
    document.getElementById('editKey').value = profile.key || '';
    document.getElementById('editHopLimit').value = profile.hop_limit !== undefined ? profile.hop_limit : 3;
    new bootstrap.Modal(document.getElementById('editProfileModal')).show();
}

function updateProfile() {
    const profileId = document.getElementById('editProfileId').value;
    const node_id = document.getElementById('editNodeId').value.trim();
    const long_name = document.getElementById('editLongName').value.trim();
    const short_name = document.getElementById('editShortName').value.trim();
    const channel = document.getElementById('editChannel').value.trim();
    const key = document.getElementById('editKey').value.trim();
    const hopLimitValue = document.getElementById('editHopLimit').value;
    const hopLimit = hopLimitValue === '' ? 3 : parseInt(hopLimitValue);

    if (!node_id || !long_name || !short_name || !channel || !key) {
        alert('All fields are required');
        return;
    }
    
    // Validate hop limit
    if (hopLimit < 0 || hopLimit > 7) {
        alert('Hop limit must be between 0 and 7');
        return;
    }

    fetch(`/api/profiles/${profileId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            node_id: node_id,
            long_name: long_name,
            short_name: short_name,
            channel: channel,
            key: key,
            hop_limit: hopLimit
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) return alert('Error: ' + data.error);
        alert('Profile updated successfully!');
        bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
        location.reload();
    })
    .catch(err => {
        console.error('Error updating profile:', err);
        alert('Error updating profile');
    });
}

function deleteProfile(profileId) {
    const profile = profiles[profileId];
    if (!profile) {
        alert('Profile not found');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the profile "${profile.long_name}"? This action cannot be undone.`)) {
        return;
    }
    
    fetch(`/api/profiles/${profileId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Profile deleted successfully!');
            location.reload(); // Reload to update the profile list
        }
    })
    .catch(error => {
        console.error('Error deleting profile:', error);
        alert('Error deleting profile');
    });
}

</script>
</script>
{% endblock %}
